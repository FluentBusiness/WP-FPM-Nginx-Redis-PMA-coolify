# Fastcgi cache path
fastcgi_cache_path /var/run/nginx-cache levels=1:2 keys_zone=WORDPRESS:100m inactive=60m;
fastcgi_cache_key "$scheme$request_method$host$request_uri";
fastcgi_cache_use_stale error timeout invalid_header http_500;
fastcgi_ignore_headers Cache-Control Expires Set-Cookie;
# End of Fastcgi cache path

server {
  listen 80 default_server;
  server_name  _;
  client_max_body_size 64M;

  keepalive_timeout          45;
  reset_timedout_connection  on;
  client_body_timeout        35;
  client_header_timeout      12;
  send_timeout               30;
  client_body_buffer_size    10K;
  client_header_buffer_size   1k;
  large_client_header_buffers 4 4k;

  root /var/www/html;

  # Add Alt-Svc header to advertise HTTP/3 support to clients
  ssl_early_data on;
  add_header Alt-Svc 'h3=":443"; ma=86400';
	
  # File to be used as index
  index index.php index.html;

  server_tokens off;
 
# BEGIN CompressX
set $ext_avif ".avif";
if ($http_accept !~* "image/avif") {
  set $ext_avif "";
}

set $ext_webp ".webp";
if ($http_accept !~* "image/webp") {
  set $ext_webp "";
}

location ~ /wp-content/(?<path>.+)\.(?<ext>jpe?g|png|gif|webp)$ {
  add_header Vary Accept;
  add_header Cache-Control "private";
  expires 365d;
  try_files
    /wp-content/compressx-nextgen/$path.$ext$ext_avif
    /wp-content/compressx-nextgen/$path.$ext$ext_webp
    /wp-content/$path.$ext
  $uri = 404;
}
# END CompressX

    location ~* /\.(?!well-known\/) {
        deny all;
    }

    location ~\.(ini|log|conf)$ {
        deny all;
    }


    # Deny access to any files with a .php extension in the uploads directory
    location ~* /(?:uploads|files)/.*\.php$ {
        deny all;
    }

    location = /xmlrpc.php {
        deny all;
    }


    # Overrides logs defined in nginx.conf, allows per site logs.
    access_log /var/log/nginx/leman.biz.ua-access.log;
    error_log /var/log/nginx/leman.biz.ua-error.log;
# The key to use when saving cache files, which will run through the MD5 hashing algorithm.
    fastcgi_cache_key "$scheme$request_method$host$request_uri";

    # If an error occurs when communicating with FastCGI server, return cached content.
    # Useful for serving cached content if the PHP process dies or timeouts.
    fastcgi_cache_use_stale error timeout updating invalid_header http_500;

    # Allow caching of requests which contain the following headers.
    fastcgi_ignore_headers Cache-Control Expires Set-Cookie;

    # Show the cache status in server responses.
    add_header Fastcgi-Cache $upstream_cache_status;

    # Don't skip by default
    set $skip_cache 0;

    # POST requests and urls with a query string should always go to PHP
    if ($request_method = POST) {
        set $skip_cache 1;
    }

    if ($query_string != "") {
        set $skip_cache 1;
    }


    # Don't cache URIs containing the following segments
    if ($request_uri ~* "/wp-admin/|/wp-json/|/xmlrpc.php|wp-.*.php|/feed/|index.php|sitemap(_index)?.xml|/cart/|/checkout/|/my-account/|ao_noptirocket|ao_speedup_cachebuster|removed_item|/my-account|/wc-api|/edd-api|/wp-json|/wp-admin|/wp-login") {
        set $skip_cache 1;
    }


    # Don't use the cache for logged in users or recent commenters
    if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in|edd_items_in_cart|woocommerce_items_in_cart|comment_|woocommerce_|wordpress|xf_|edd_|jetpack|yith_wcwl_session_|yith_wrvp_|wpsc_|ecwid|ec_|bookly") {
        set $skip_cache 1;
    } 
 
     location / {
        try_files $uri $uri/ /index.php?$args;
    }
 
  location ~ \.php$ {
    try_files $uri =404;
	fastcgi_buffer_size 128k;
    fastcgi_busy_buffers_size 256k;
    fastcgi_buffers 4 256k;
	
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    fastcgi_pass wordpress:9000;

    fastcgi_cache_bypass $skip_cache;
    fastcgi_no_cache $skip_cache;
    fastcgi_cache WORDPRESS;
    fastcgi_cache_valid 60m;

    add_header X-Cache $upstream_cache_status;
    add_header X-Cache-Enabled "true";
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options "nosniff";
  
	add_header Alt-Svc 'h3=":443"; ma=86400' always;
	fastcgi_index index.php;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

# Manually set these params for HTTP/3 support to avoid undefined variable issues
    fastcgi_param HTTP_HOST $host;
    fastcgi_param REQUEST_SCHEME $scheme;
    fastcgi_param HTTPS on;

	
    proxy_set_header Host $host;	
    proxy_set_header X-Forwarded-Host $http_host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Real-IP $remote_addr;
    }

    # Rewrite robots.txt
    rewrite ^/robots.txt$ /index.php last;

    location = /robots.txt { access_log off; log_not_found off; }

  location ~* /uploads/.*\.php$ {
      return 503;
   }

  location ~ /\.ht {
      deny all;
    }

    # Кэширование статики
  location ~* ^.+\.(ogg|ogv|svg|svgz|eot|otf|woff|woff2|mp4|ttf|ttc|rss|atom|jpg|jpeg|gif|png|ico|webp|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf|css|js|html|xml)$ {
      access_log off; log_not_found off; expires max; add_header Cache-Control "public";	  
    }
	


  # common gzip
  gzip on;
  gzip_comp_level 6;  
  gzip_min_length 1100;
  gzip_buffers    4   32k;
  gzip_types  text/css text/less text/plain text/xml application/xml application/json application/javascript application/pdf image/jpeg image/png;
  gzip_vary   on;
  gzip_proxied    no-cache no-store private expired auth;
  gzip_disable        "msie6";


}
