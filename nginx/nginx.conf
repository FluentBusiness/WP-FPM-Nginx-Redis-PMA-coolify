# =========================================================================
# 1. НАСТРОЙКИ КЭША FASTCGI
# =========================================================================

# fastcgi_cache_path:
# /var/run/nginx-cache - путь внутри контейнера (смонтирован через docker-compose)
# levels=1:2 - структура подпапок (для производительности)
# keys_zone=WORDPRESS:100m - имя зоны кэша и размер памяти для ключей (100МБ)
# inactive=60m - удалять кэш, если к нему не обращались 60 минут
fastcgi_cache_path /var/run/nginx-cache levels=1:2 keys_zone=WORDPRESS:100m inactive=60m;

# Ключ кэширования. Важно: плагин Nginx Helper ожидает именно такой формат.
fastcgi_cache_key "$scheme$request_method$host$request_uri";

# Если PHP упал или выдает ошибку, отдавать старый кэш (чтобы сайт работал)
fastcgi_cache_use_stale error timeout invalid_header http_500 updating;

# Игнорируем заголовки от WP, которые могут запрещать кэширование
fastcgi_ignore_headers Cache-Control Expires Set-Cookie;

# =========================================================================
# 2. ЛОГИКА ИСКЛЮЧЕНИЙ (MAPS)
# Здесь мы определяем условия, при которых кэш НЕ должен работать.
# =========================================================================

# Если метод POST (отправка формы) -> не кэшируем (skip_cache = 1)
map $request_method $skip_cache {
    default 0;
    POST    1;
}

# Если есть query string (параметры в URL), кроме разрешенных -> не кэшируем
# Например, ?s=search не кэшируется по умолчанию.
map $query_string $skip_cache_query {
    default 0;
    "~.+"   1; 
}

# Если пользователь залогинен или что-то лежит в корзине -> не кэшируем
map $http_cookie $skip_cache_cookie {
    default 0;
    "~*comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in" 1;
    "~*woocommerce_items_in_cart|edd_items_in_cart|woocommerce_cart_hash" 1;
}

# =========================================================================
# 3. НАСТРОЙКИ СЕРВЕРА
# =========================================================================

server {
  listen 80 default_server;
  server_name _;
  
  # ЛИМИТЫ И ТАЙМАУТЫ
  # Должно совпадать с upload_max_filesize в php.ini
  client_max_body_size 256M;

  # Увеличенные таймауты для долгих операций (импорт, бэкапы)
  fastcgi_read_timeout 600s;
  fastcgi_send_timeout 600s;
  fastcgi_connect_timeout 60s;
  
  # Базовые настройки сети
  keepalive_timeout 45;
  reset_timedout_connection on;
  client_body_timeout 35;
  client_header_timeout 12;
  send_timeout 30;
  
  root /var/www/html;
  index index.php index.html;
  server_tokens off;
  
  # Логи (проброшены в volumes)
  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log;

  # -----------------------------------------------------------------------
  # БЛОК CompressX (WebP / AVIF)
  # Официальные правила рерайта для плагина CompressX
  # -----------------------------------------------------------------------
  
  # Проверяем поддержку AVIF браузером
  set $ext_avif ".avif";
  if ($http_accept !~* "image/avif") { set $ext_avif ""; }

  # Проверяем поддержку WebP браузером
  set $ext_webp ".webp";
  if ($http_accept !~* "image/webp") { set $ext_webp ""; }

  # Если запрашивается картинка, пытаемся отдать ее оптимизированную версию
  location ~ /wp-content/(?<path>.+)\.(?<ext>jpe?g|png|gif|webp)$ {
    add_header Vary Accept;
    add_header Cache-Control "private";
    expires 365d;
    
    # Порядок проверки:
    # 1. AVIF версия в папке compressx-nextgen
    # 2. WebP версия в папке compressx-nextgen
    # 3. Оригинал
    try_files
      /wp-content/compressx-nextgen/$path.$ext$ext_avif
      /wp-content/compressx-nextgen/$path.$ext$ext_webp
      /wp-content/$path.$ext
      $uri =404;
  }
  # -----------------------------------------------------------------------

  # БЕЗОПАСНОСТЬ
  # Запрет доступа к скрытым файлам (.git, .env и т.д.)
  location ~* /\.(?!well-known\/) { deny all; }
  # Запрет доступа к конфигам и логам
  location ~\.(ini|log|conf)$ { deny all; }
  # Запрет выполнения PHP в папках загрузок (защита от взлома)
  location ~* /(?:uploads|files)/.*\.php$ { deny all; }
  # Блокировка XMLRPC (защита от DDoS и брутфорса)
  location = /xmlrpc.php { deny all; }

  # Обработка robots.txt
  location = /robots.txt { 
    try_files $uri $uri/ /index.php?$args; 
    access_log off; log_not_found off; 
  }

  # -----------------------------------------------------------------------
  # СБОРКА УСЛОВИЙ ПРОПУСКА КЭША
  # Здесь мы объединяем результаты MAPS в одну переменную $do_skip_cache
  # -----------------------------------------------------------------------
  set $do_skip_cache 0;

  # 1. Метод (POST)
  if ($skip_cache) { set $do_skip_cache 1; }
  
  # 2. Параметры URL
  if ($query_string != "") { set $do_skip_cache 1; }

  # 3. Куки авторизации
  if ($skip_cache_cookie) { set $do_skip_cache 1; }

  # 4. Специфические страницы WP (админка, фиды, sitemap)
  if ($request_uri ~* "/wp-admin/|/wp-json/|/xmlrpc.php|wp-.*.php|/feed/|index.php|sitemap(_index)?.xml") {
      set $do_skip_cache 1;
  }
  # 5. Страницы магазина (WooCommerce/EDD)
  if ($request_uri ~* "/cart/|/checkout/|/my-account/|/wc-api|/edd-api|/wp-login") {
      set $do_skip_cache 1;
  }

  # -----------------------------------------------------------------------
  # ОСНОВНОЙ БЛОК
  # -----------------------------------------------------------------------
  location / {
      try_files $uri $uri/ /index.php?$args;
  }
 
  location ~ \.php$ {
    try_files $uri =404;
    
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    
    # Имя сервиса PHP из docker-compose (wordpress:9000)
    fastcgi_pass wordpress:9000;
    
    fastcgi_index index.php;
    include fastcgi_params;
    
    # ПАРАМЕТРЫ ПЕРЕДАЧИ В PHP
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param HTTP_HOST $host;
    fastcgi_param REQUEST_SCHEME $scheme;
    fastcgi_param HTTPS on; # Важно для работы за прокси (Coolify)

    # НАСТРОЙКИ КЭШИРОВАНИЯ
    fastcgi_cache WORDPRESS;        # Имя зоны, определенное в начале файла
    fastcgi_cache_valid 200 60m;    # Успешные ответы (код 200) кэшируем на 60 мин
    
    # Применение логики пропуска кэша
    fastcgi_cache_bypass $do_skip_cache;
    fastcgi_no_cache $do_skip_cache;

    # Хедер для отладки (видно в DevTools -> Network)
    # HIT = взято из кэша, MISS = сгенерировано PHP, BYPASS = кэш пропущен
    add_header X-FastCGI-Cache $upstream_cache_status;
    
    # БУФЕРЫ (оптимизация)
    fastcgi_buffer_size 128k;
    fastcgi_busy_buffers_size 256k;
    fastcgi_buffers 4 256k;
    
    # ПРОКСИ ХЕДЕРЫ
    proxy_set_header Host $host;    
    proxy_set_header X-Forwarded-Host $http_host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Real-IP $remote_addr;
    
    # ХЕДЕРЫ БЕЗОПАСНОСТИ
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options "nosniff";
  }

  # Запрет доступа к .ht файлам (Apache style)
  location ~ /\.ht {
      deny all;
  }

  # СТАТИКА (Кэширование браузером)
  location ~* ^.+\.(ogg|ogv|svg|svgz|eot|otf|woff|woff2|mp4|ttf|ttc|rss|atom|jpg|jpeg|gif|png|ico|webp|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf|css|js|html|xml|avif)$ {
      access_log off; 
      expires max; 
      add_header Cache-Control "public, no-transform";     
  }
    
  # GZIP СЖАТИЕ
  gzip on;
  gzip_comp_level 6;  
  gzip_min_length 1100;
  gzip_buffers 4 32k;
  gzip_types text/css text/plain application/json application/javascript application/xml image/svg+xml;
  gzip_vary on;
  gzip_proxied any;
  gzip_disable "msie6";
}